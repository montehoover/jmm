#include <errno.h>
#include <stdio.h>
#include <stdlib.h>

#include <eik3.h>
#include <mesh3.h>

#define R0 0.1

int main(int argc, char *argv[]) {
  if (argc != 3) {
    printf("usage: %s <verts.bin> <cells.bin>\n",
           argv[0]);
    exit(EXIT_FAILURE);
  }

  size_t vertsize = 3*sizeof(dbl), nverts;
  size_t cellsize = 4*sizeof(size_t), ncells;
  dbl *verts;
  size_t *cells;

  FILE *fp = NULL;

  /**
   * Set up mesh
   */

  // Read verts from binary file at argv[1]
  fp = fopen(argv[1], "rb");
  fseek(fp, 0, SEEK_END);
  nverts = ftell(fp)/vertsize;
  rewind(fp);
  verts = malloc(vertsize*nverts);
  fread(verts, vertsize, nverts, fp);
  fclose(fp);

  // Read cells from binary file at argv[2]
  fp = fopen(argv[2], "rb");
  fseek(fp, 0, SEEK_END);
  ncells = ftell(fp)/cellsize;
  rewind(fp);
  cells = malloc(cellsize*ncells);
  fread(cells, cellsize, ncells, fp);
  fclose(fp);

  // Create tetrahedron mesh for solver
  mesh3_s *mesh;
  mesh3_alloc(&mesh);
  mesh3_init(mesh, verts, nverts, cells, ncells, true);

  size_t le_diff[][2] = {
    {50, 3162},
    {50, 3311},
    {95, 3092},
    {95, 3226},
    {96, 3094},
    {96, 3225},
    {197, 3054},
    {197, 3229},
    {211, 2515},
    {211, 2966},
    {290, 3223},
    {290, 3342},
    {291, 3224},
    {291, 3361},
    {330, 3115},
    {330, 3276},
    {333, 2958},
    {333, 3258},
    {405, 3227},
    {405, 3381},
    {406, 3220},
    {406, 3362},
    {452, 3170},
    {452, 3256},
    {577, 3156},
    {577, 3230},
    {634, 3216},
    {634, 3372},
    {829, 3214},
    {829, 3372},
    {873, 3251},
    {873, 3339},
    {874, 3252},
    {874, 3340},
    {909, 3125},
    {909, 3324},
    {927, 2475},
    {927, 2963},
    {989, 3167},
    {989, 6424},
    {990, 3051},
    {990, 6425},
    {1046, 2960},
    {1046, 3270},
    {1199, 2957},
    {1199, 3312},
    {1290, 3128},
    {1290, 3236},
    {1291, 3073},
    {1291, 5994},
    {1709, 3226},
    {1709, 3381},
    {1717, 3225},
    {1717, 3362},
    {1867, 3174},
    {1867, 3323},
    {1894, 2989},
    {1894, 3173},
    {2013, 3071},
    {2013, 3303},
    {2327, 3039},
    {2327, 3214},
    {2349, 2963},
    {2349, 3300},
    {2402, 3146},
    {2402, 3270},
    {2460, 2937},
    {2460, 3065},
    {2463, 4929},
    {2463, 6956},
    {2464, 3146},
    {2464, 5304},
    {2466, 3061},
    {2466, 7479},
    {2469, 3162},
    {2469, 4627},
    {2470, 6913},
    {2470, 7512},
    {2475, 5707},
    {2515, 5355},
    {2521, 4264},
    {2521, 4843},
    {2570, 3050},
    {2570, 3228},
    {2584, 3049},
    {2584, 3235},
    {2600, 3058},
    {2600, 3312},
    {2748, 3171},
    {2748, 3300},
    {2754, 3230},
    {2754, 3384},
    {2755, 3229},
    {2755, 3385},
    {2825, 2958},
    {2825, 3260},
    {2893, 3813},
    {2893, 3908},
    {2931, 4363},
    {2931, 4406},
    {2937, 4363},
    {2938, 4020},
    {2938, 4121},
    {2939, 3620},
    {2939, 4061},
    {2940, 4020},
    {2940, 6956},
    {2944, 4589},
    {2944, 6845},
    {2957, 4288},
    {2960, 4331},
    {2966, 4843},
    {2989, 3492},
    {3039, 4929},
    {3040, 3762},
    {3042, 3761},
    {3043, 4780},
    {3053, 6290},
    {3056, 6291},
    {3058, 5304},
    {3061, 3658},
    {3064, 3928},
    {3064, 6913},
    {3065, 4229},
    {3067, 3173},
    {3067, 3790},
    {3069, 3908},
    {3069, 5355},
    {3071, 4121},
    {3074, 3893},
    {3074, 7479},
    {3075, 6784},
    {3078, 6794},
    {3080, 4011},
    {3082, 4784},
    {3084, 3452},
    {3088, 4010},
    {3095, 4140},
    {3099, 4132},
    {3102, 3249},
    {3109, 3973},
    {3109, 7512},
    {3115, 3813},
    {3125, 4350},
    {3145, 3250},
    {3148, 3347},
    {3149, 4093},
    {3149, 4187},
    {3165, 3171},
    {3165, 4231},
    {3169, 3714},
    {3169, 4264},
    {3170, 5707},
    {3172, 3492},
    {3172, 4231},
    {3177, 3851},
    {3216, 7167},
    {3220, 6784},
    {3221, 4189},
    {3221, 6291},
    {3222, 4190},
    {3222, 6290},
    {3223, 6424},
    {3224, 6425},
    {3227, 6794},
    {3228, 5052},
    {3231, 3384},
    {3231, 4010},
    {3232, 3385},
    {3232, 4011},
    {3233, 4132},
    {3233, 4567},
    {3234, 4140},
    {3234, 4568},
    {3235, 5051},
    {3236, 3342},
    {3246, 3361},
    {3246, 5994},
    {3249, 3682},
    {3250, 3683},
    {3251, 4784},
    {3252, 4780},
    {3256, 3714},
    {3258, 3928},
    {3260, 3516},
    {3263, 3658},
    {3263, 4331},
    {3267, 3893},
    {3267, 4288},
    {3268, 3620},
    {3268, 3973},
    {3276, 3851},
    {3290, 4229},
    {3290, 6845},
    {3303, 4406},
    {3311, 4061},
    {3320, 4187},
    {3320, 4589},
    {3323, 4350},
    {3324, 3790},
    {3325, 3761},
    {3325, 3921},
    {3326, 3762},
    {3326, 3940},
    {3330, 3334},
    {3330, 3338},
    {3334, 3452},
    {3338, 3358},
    {3339, 3683},
    {3340, 3682},
    {3341, 4189},
    {3341, 5051},
    {3345, 4190},
    {3345, 5052},
    {3347, 3354},
    {3354, 3358},
    {3383, 3940},
    {3383, 4568},
    {3386, 3921},
    {3386, 4567},
    {3516, 4627},
    {4093, 7167},
  };
  for (size_t i = 0; i < 222; ++i)
    mesh3_set_bde(mesh, le_diff[i], true);

  // bcs

  size_t le[8][2] = {
    {50, 3162},
    {50, 3311},
    {2939, 3620},
    {2939, 4061},
    {3109, 3973},
    {3268, 3620},
    {3268, 3973},
    {3311, 4061},
  };

  jet3 jets[8][2] = {
    {{.f = 3.430141780243402, .fx = -0.0453961764937184, .fy = 0.71741293701778, .fz = -0.6951675085612632},
     {.f = 3.891347118620549, .fx = -0.03758196490458822, .fy = 0.6305241314254901, .fz = -0.7752592570257008}},
    {{.f = 3.430141780243402, .fx = -0.0453961764937184, .fy = 0.71741293701778, .fz = -0.6951675085612632},
     {.f = 3.028953237902319, .fx = -0.06267063841483814, .fy = 0.8096404253989146, .fz = -0.5835707092037272}},
    {{.f = 2.511908055766065, .fx = -0.0812876683126976, .fy = 0.9728172162857847, .fz = -0.2168386005264321},
     {.f = 2.467561460812955, .fx = -0.06372380376475013, .fy = 0.9969956256357482, .fz = 0.04403406972941332}},
    {{.f = 2.511908055766065, .fx = -0.0812876683126976, .fy = 0.9728172162857847, .fz = -0.2168386005264321},
     {.f = 2.714117608704204, .fx = -0.06770087841060418, .fy = 0.907603374709456, .fz = -0.4143340503487972}},
    {{.f = 3.153999875558343, .fx = -0.04428550652891988, .fy = 0.7770877234541291, .fz = 0.6278323533940855},
     {.f = 2.802075606023654, .fx = -0.04716570416227321, .fy = 0.8703389616037863, .fz = 0.4901892371985741}},
    {{.f = 2.557055018823398, .fx = -0.06039151595587982, .fy = 0.9575156078434121, .fz = 0.2819871017206495},
     {.f = 2.467561460812955, .fx = -0.06372380376475013, .fy = 0.9969956256357482, .fz = 0.04403406972941332}},
    {{.f = 2.557055018823398, .fx = -0.06039151595587982, .fy = 0.9575156078434121, .fz = 0.2819871017206495},
     {.f = 2.802075606023654, .fx = -0.04716570416227321, .fy = 0.8703389616037863, .fz = 0.4901892371985741}},
    {{.f = 3.028953237902319, .fx = -0.06267063841483814, .fy = 0.8096404253989146, .fz = -0.5835707092037272},
     {.f = 2.714117608704204, .fx = -0.06770087841060418, .fy = 0.907603374709456, .fz = -0.4143340503487972}},
  };

  // Set up solver
  eik3_s *eik;
  eik3_alloc(&eik);
  eik3_init(eik, mesh);

  for (size_t i = 0; i < 8; ++i)
    eik3_add_valid_bde(eik, le[i], jets[i]);

  eik3_solve(eik);

  /* Clean everything up */

  eik3_deinit(eik);
  eik3_dealloc(&eik);

  mesh3_deinit(mesh);
  mesh3_dealloc(&mesh);

  free(verts);
  free(cells);
}
